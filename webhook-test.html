<!DOCTYPE html>
<html>
<head>
    <title>Webhook Streaming Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        input, button {
            padding: 10px;
            margin: 5px;
            font-size: 14px;
        }
        input {
            width: 500px;
            background: #2a2a2a;
            border: 1px solid #00ff00;
            color: #00ff00;
        }
        button {
            background: #00ff00;
            color: #1a1a1a;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #00cc00;
        }
        .output {
            background: #0a0a0a;
            padding: 15px;
            border: 1px solid #00ff00;
            margin: 10px 0;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .chunk {
            border-left: 3px solid #00ff00;
            padding-left: 10px;
            margin: 5px 0;
        }
        .error {
            color: #ff0000;
            border-left-color: #ff0000;
        }
        .success {
            color: #00ff00;
        }
        .warning {
            color: #ffaa00;
        }
        .info {
            color: #00aaff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Webhook Streaming Diagnostic Tool</h1>

        <div>
            <label>Webhook URL:</label><br>
            <input type="text" id="webhookUrl" value="https://n8n-self-host-gedarta.onrender.com/webhook-test/16bbcb4a-d49e-4590-883b-440eb952b3c6" />
        </div>

        <div>
            <label>Test Question:</label><br>
            <input type="text" id="question" value="Hello, can you hear me?" />
        </div>

        <div>
            <button onclick="testWebhook()">üöÄ Test Webhook Streaming</button>
            <button onclick="clearOutput()">üóëÔ∏è Clear Output</button>
        </div>

        <h2>üìä Diagnostics Output:</h2>
        <div id="output" class="output"></div>

        <h2>üì¶ Received Chunks:</h2>
        <div id="chunks" class="output"></div>

        <h2>üìù Final Response:</h2>
        <div id="final" class="output"></div>
    </div>

    <script>
        let chunkCount = 0;
        let fullResponse = '';

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const line = document.createElement('div');
            line.className = type;
            line.textContent = new Date().toISOString().substring(11, 23) + ' ' + message;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        function addChunk(chunk, index) {
            const chunks = document.getElementById('chunks');
            const chunkDiv = document.createElement('div');
            chunkDiv.className = 'chunk';
            chunkDiv.textContent = `Chunk #${index}: ${chunk}`;
            chunks.appendChild(chunkDiv);
            chunks.scrollTop = chunks.scrollHeight;
        }

        function updateFinal(text) {
            document.getElementById('final').textContent = text;
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
            document.getElementById('chunks').innerHTML = '';
            document.getElementById('final').textContent = '';
            chunkCount = 0;
            fullResponse = '';
        }

        async function testWebhook() {
            clearOutput();
            const url = document.getElementById('webhookUrl').value;
            const question = document.getElementById('question').value;

            log('=== STARTING WEBHOOK TEST ===', 'success');
            log(`URL: ${url}`, 'info');
            log(`Question: ${question}`, 'info');

            try {
                log('üì° Sending POST request...', 'info');

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: question,
                        chat_id: 'test-123',
                        user_id: 'test-user',
                        project_id: 'test-project'
                    })
                });

                log('‚úÖ Response received!', 'success');
                log(`Status: ${response.status} ${response.statusText}`, 'success');

                // Log all headers
                log('=== RESPONSE HEADERS ===', 'info');
                response.headers.forEach((value, key) => {
                    log(`${key}: ${value}`, 'info');
                });

                const contentType = response.headers.get('content-type');
                log(`Content-Type: ${contentType}`, contentType?.includes('stream') ? 'success' : 'warning');

                if (!response.ok) {
                    log(`‚ùå HTTP Error: ${response.status}`, 'error');
                    const errorText = await response.text();
                    log(`Error body: ${errorText}`, 'error');
                    return;
                }

                const reader = response.body?.getReader();
                if (!reader) {
                    log('‚ùå No reader available - response body is null!', 'error');
                    return;
                }

                log('‚úÖ Reader available, starting to read stream...', 'success');
                const decoder = new TextDecoder();

                try {
                    while (true) {
                        const { done, value } = await reader.read();

                        if (done) {
                            log(`‚úÖ Stream complete! Total chunks: ${chunkCount}`, 'success');
                            log(`Final response length: ${fullResponse.length} characters`, 'success');
                            break;
                        }

                        chunkCount++;
                        const chunk = decoder.decode(value, { stream: true });
                        log(`üì¶ Chunk #${chunkCount} received (${chunk.length} bytes)`, 'info');
                        addChunk(chunk, chunkCount);

                        // Parse the chunk
                        const lines = chunk.split('\n');
                        log(`  ‚Üí Split into ${lines.length} lines`, 'info');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                // SSE format
                                const data = line.slice(6).trim();
                                log(`  üì® SSE format detected`, 'success');

                                if (data && data !== '[DONE]') {
                                    try {
                                        const parsed = JSON.parse(data);
                                        log(`  ‚úì Valid JSON: ${JSON.stringify(parsed)}`, 'success');

                                        if (parsed.response) {
                                            fullResponse += parsed.response;
                                            log(`  ‚úì Found "response" field: "${parsed.response}"`, 'success');
                                            updateFinal(fullResponse);
                                        } else {
                                            log(`  ‚ö†Ô∏è No "response" field! Available fields: ${Object.keys(parsed).join(', ')}`, 'warning');
                                            log(`  üí° Your n8n should output: {"response": "text"}`, 'warning');
                                        }
                                    } catch (e) {
                                        log(`  ‚ÑπÔ∏è Not JSON, treating as plain text: "${data}"`, 'info');
                                        fullResponse += data;
                                        updateFinal(fullResponse);
                                    }
                                }
                            } else if (line.trim() && !line.startsWith(':')) {
                                // Plain text or newline-delimited JSON
                                log(`  üìù Plain text/JSON line detected`, 'info');

                                try {
                                    const parsed = JSON.parse(line);
                                    log(`  ‚úì Valid JSON: ${JSON.stringify(parsed)}`, 'success');

                                    if (parsed.response) {
                                        fullResponse += parsed.response;
                                        log(`  ‚úì Found "response" field: "${parsed.response}"`, 'success');
                                        updateFinal(fullResponse);
                                    } else {
                                        log(`  ‚ö†Ô∏è No "response" field! Available fields: ${Object.keys(parsed).join(', ')}`, 'warning');
                                    }
                                } catch (e) {
                                    log(`  ‚ÑπÔ∏è Not JSON, treating as plain text: "${line}"`, 'info');
                                    fullResponse += line;
                                    updateFinal(fullResponse);
                                }
                            } else if (line.trim()) {
                                log(`  üîá Comment line (ignored): ${line.substring(0, 30)}`, 'info');
                            }
                        }
                    }

                    log('=== TEST COMPLETE ===', 'success');
                    if (fullResponse.length === 0) {
                        log('‚ùå WARNING: No content was extracted from the stream!', 'error');
                        log('üí° Possible issues:', 'warning');
                        log('   1. n8n is not using "response" field name', 'warning');
                        log('   2. n8n is not outputting JSON format', 'warning');
                        log('   3. n8n response is empty', 'warning');
                    } else {
                        log(`‚úÖ SUCCESS: Extracted ${fullResponse.length} characters`, 'success');
                    }

                } finally {
                    reader.releaseLock();
                }

            } catch (error) {
                log(`‚ùå ERROR: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
            }
        }

        // Auto-run on load for quick testing
        log('Ready to test! Click the button to start.', 'info');
    </script>
</body>
</html>
