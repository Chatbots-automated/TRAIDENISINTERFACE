<!DOCTYPE html>
<html>
<head>
    <title>PostgREST Test</title>
</head>
<body>
    <h1>PostgREST Connection Test</h1>
    <button onclick="testConnection()">Test Connection</button>
    <button onclick="testLogin()">Test Login</button>
    <div id="result" style="margin-top: 20px; white-space: pre-wrap; font-family: monospace;"></div>

    <script>
        const POSTGREST_URL = 'https://api.traidenis.org';
        const POSTGREST_ANON_KEY = 'anon';

        async function testConnection() {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = 'Testing connection...\n';

            try {
                // Test 1: Simple GET request
                console.log('Test 1: Simple GET to /app_users');
                const url1 = `${POSTGREST_URL}/app_users?select=id,email&limit=1`;
                console.log('URL:', url1);

                const response1 = await fetch(url1, {
                    method: 'GET',
                    headers: {
                        'apikey': POSTGREST_ANON_KEY,
                        'Content-Type': 'application/json'
                    }
                });

                resultDiv.textContent += `\nTest 1: GET /app_users\n`;
                resultDiv.textContent += `Status: ${response1.status} ${response1.statusText}\n`;
                resultDiv.textContent += `Headers: ${JSON.stringify(Object.fromEntries(response1.headers.entries()), null, 2)}\n`;

                if (response1.ok) {
                    const data1 = await response1.json();
                    resultDiv.textContent += `Response: ${JSON.stringify(data1, null, 2)}\n`;
                } else {
                    const error1 = await response1.text();
                    resultDiv.textContent += `Error: ${error1}\n`;
                }

                // Test 2: GET with filters (like login query)
                console.log('\nTest 2: GET with email filter');
                const url2 = `${POSTGREST_URL}/app_users?email=eq.nojus@eiternus.com&password=eq.ZXCvbn123&select=*`;
                console.log('URL:', url2);

                const response2 = await fetch(url2, {
                    method: 'GET',
                    headers: {
                        'apikey': POSTGREST_ANON_KEY,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.pgrst.object+json'
                    }
                });

                resultDiv.textContent += `\nTest 2: Login Query\n`;
                resultDiv.textContent += `Status: ${response2.status} ${response2.statusText}\n`;

                if (response2.ok) {
                    const data2 = await response2.json();
                    resultDiv.textContent += `Response: ${JSON.stringify(data2, null, 2)}\n`;
                } else {
                    const error2 = await response2.text();
                    resultDiv.textContent += `Error: ${error2}\n`;
                }

            } catch (error) {
                resultDiv.textContent += `\nFetch Error: ${error.message}\n`;
                resultDiv.textContent += `Stack: ${error.stack}\n`;
            }
        }

        async function testLogin() {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = 'Testing login flow...\n';

            try {
                const email = 'nojus@eiternus.com';
                const password = 'ZXCvbn123';

                // Construct URL like the PostgREST client does
                const url = `${POSTGREST_URL}/app_users?email=eq.${email}&password=eq.${password}`;
                resultDiv.textContent += `URL: ${url}\n\n`;

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'apikey': POSTGREST_ANON_KEY,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.pgrst.object+json'
                    }
                });

                resultDiv.textContent += `Status: ${response.status} ${response.statusText}\n`;
                resultDiv.textContent += `Headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}\n\n`;

                if (response.ok) {
                    const userData = await response.json();
                    resultDiv.textContent += `✅ Login successful!\n`;
                    resultDiv.textContent += `User: ${JSON.stringify(userData, null, 2)}\n`;
                } else {
                    const errorText = await response.text();
                    resultDiv.textContent += `❌ Login failed!\n`;
                    resultDiv.textContent += `Error: ${errorText}\n`;
                }
            } catch (error) {
                resultDiv.textContent += `\n❌ Network Error: ${error.message}\n`;
                resultDiv.textContent += `Stack: ${error.stack}\n`;
            }
        }
    </script>
</body>
</html>
